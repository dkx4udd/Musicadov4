{% comment %}
  Multilingual Discount Modal - Supports Dutch & English
  Save this as: snippets/discount-modal.liquid
{% endcomment %}

<!-- Discount Modal -->
<div id="discountModal" class="discount-modal" style="display: none;">
  <div class="discount-modal-overlay">
    <div class="modal-content">
      <span class="discount-close">&times;</span>
      
      <!-- Email Step (Default visible) -->
      <div class="discount-step" id="emailStep">
        <h2 data-translate="discountTitle">üéµ Get 15% OFF Your Purchase!</h2>
        <p data-translate="discountEmailDescription">Enter your email to unlock 15% off your custom song creation!</p>
        
        <div class="email-form">
          <input type="email" id="discountEmail" data-translate-placeholder="discountEmailPlaceholder" placeholder="Enter your email address" autocomplete="email">
          
          <div class="email-consent-section" id="emailConsentCheckbox">
            <label class="consent-checkbox">
              <input type="checkbox" id="emailConsent">
              <span class="checkmark"></span>
              <span data-translate="emailConsentText">I agree to receive promotional emails and special offers from musicado. You can unsubscribe at any time.</span>
            </label>
          </div>
          
          <button type="button" id="submitDiscountEmail" class="btn discount-submit-btn">
            <span data-translate="getDiscount">Get My 15% Discount</span>
          </button>
        </div>
        
        <div class="privacy-note">
          <small data-translate="discountTermsPrivacy">We respect your privacy. No spam, and you can unsubscribe anytime.</small>
        </div>
      </div>

      <!-- Code Step (Hidden by default) -->
      <div class="discount-step" id="codeStep" style="display: none;">
        <h2 data-translate="discountSuccessTitle">üéâ Your Discount Code!</h2>
        <p data-translate="discountSuccessMessage">Here's your 15% discount code. Copy it and use it at checkout:</p>
        
        <div class="discount-code-display">
          <div class="code-box">
            <span class="discount-code-text" id="discountCodeText">MUSIC15</span>
            <button type="button" id="copyDiscountCode" class="btn copy-code-btn">
              <span class="copy-text" data-translate="copyCode">Copy Code</span>
              <span class="copied-text" data-translate="codeCopied" style="display: none;">Code Copied!</span>
            </button>
          </div>
        </div>
        
        <div class="code-validity-info">
          <p><small data-translate="discountValidityInfo">This code is valid for 30 days. Save it for your order!</small></p>
        </div>
        
        <button type="button" class="btn continue-shopping-btn" onclick="closeDiscountModal()">
          <span data-translate="continueToCheckout">Close & Continue Shopping</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Full Album Contact Modal -->
<div id="fullAlbumModal" class="discount-modal" style="display: none;">
  <div class="discount-modal-overlay">
    <div class="modal-content">
      <span class="discount-close" id="fullAlbumClose">&times;</span>
      <div class="discount-step">
        <h2 data-translate="fullAlbumContactTitle">üéµ Full Album Inquiry</h2>
        <p data-translate="fullAlbumContactDescription">Interested in a full album? We'd love to create something amazing for you! Leave your details and we'll contact you within 24 hours with a personalized quote.</p>
        
        <form id="fullAlbumContactForm" class="full-album-form">
          <div class="form-group">
            <label for="fullAlbumEmail" data-translate="emailAddress">Email Address *</label>
            <input type="email" id="fullAlbumEmail" name="email" required data-translate-placeholder="emailPlaceholder" placeholder="your@email.com">
          </div>
          
          <div class="form-group">
            <label for="fullAlbumPhone" data-translate="phoneNumber">Mobile Phone *</label>
            <input type="tel" id="fullAlbumPhone" name="phone" required data-translate-placeholder="phonePlaceholder" placeholder="+31 6 12345678">
          </div>
          
          <div class="form-group">
            <label for="fullAlbumTopic" data-translate="topic">Topic</label>
            <input type="text" id="fullAlbumTopic" name="topic" value="Interested in a full album please contact me">
          </div>
          
          <div class="form-group">
            <label for="fullAlbumNotes" data-translate="additionalNotes">Additional Notes (Optional)</label>
            <textarea id="fullAlbumNotes" name="notes" rows="4" data-translate-placeholder="notesPlaceholder" placeholder="Tell us more about your album vision..."></textarea>
          </div>
          
          <button type="submit" class="btn full-album-submit-btn">
            <span data-translate="submitContact">Submit Contact Request</span>
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Enhanced modal functions with proper translations
function closeDiscountModal() {
  const modal = document.getElementById('discountModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
}

function showCodeStep() {
  const emailStep = document.getElementById('emailStep');
  const codeStep = document.getElementById('codeStep');
  
  console.log('Switching to code step...', { emailStep: !!emailStep, codeStep: !!codeStep });
  
  if (emailStep) emailStep.style.display = 'none';
  if (codeStep) codeStep.style.display = 'block';
}

function copyDiscountCode() {
  const codeText = 'MUSIC15';
  const copyBtn = document.getElementById('copyDiscountCode');
  const copyTextSpan = copyBtn ? copyBtn.querySelector('.copy-text') : null;
  const copiedTextSpan = copyBtn ? copyBtn.querySelector('.copied-text') : null;
  
  console.log('Copying code:', codeText);
  
  // Try modern clipboard API first
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(codeText).then(() => {
      console.log('‚úÖ Code copied successfully');
      showCopySuccess();
    }).catch((err) => {
      console.log('‚ùå Modern copy failed, trying fallback');
      fallbackCopy(codeText);
    });
  } else {
    console.log('üìã Using fallback copy method');
    fallbackCopy(codeText);
  }
  
  function showCopySuccess() {
    // Show success state
    if (copyTextSpan) copyTextSpan.style.display = 'none';
    if (copiedTextSpan) copiedTextSpan.style.display = 'inline';
    if (copyBtn) {
      copyBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
      copyBtn.style.color = 'white';
    }
    
    // Show notification
    showCopyNotification();
    
    // Reset button after 3 seconds
    setTimeout(() => {
      if (copyTextSpan) copyTextSpan.style.display = 'inline';
      if (copiedTextSpan) copiedTextSpan.style.display = 'none';
      if (copyBtn) {
        copyBtn.style.background = '';
        copyBtn.style.color = '';
      }
    }, 3000);
  }
  
  function fallbackCopy(text) {
    try {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.top = '-9999px';
      textArea.style.left = '-9999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      const successful = document.execCommand('copy');
      document.body.removeChild(textArea);
      
      if (successful) {
        console.log('‚úÖ Fallback copy successful');
        showCopySuccess();
      } else {
        console.log('‚ùå Fallback copy failed');
        alert('Copy the code: ' + text);
      }
    } catch (err) {
      console.log('‚ùå All copy methods failed:', err);
      alert('Copy this code: ' + text);
    }
  }
}

function showCopyNotification() {
  // Get current language for notification text
  const currentLang = navigator.language.startsWith('nl') ? 'nl' : 'en';
  const notificationText = currentLang === 'nl' ? 
    'Code gekopieerd naar klembord!' : 
    'Code copied to clipboard!';
    
  const notification = document.createElement('div');
  notification.innerHTML = `
    <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
      <span>üìã</span>
      <span>${notificationText}</span>
    </div>
  `;
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
    z-index: 10001;
    font-weight: 600;
    animation: slideInRight 0.3s ease-out;
    max-width: 300px;
    text-align: center;
    line-height: 1.4;
  `;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentNode) {
      notification.parentNode.removeChild(notification);
    }
  }, 3000);
}

// Initialize modal functionality when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  console.log('‚úÖ Multilingual discount modal initialized');
  
  // Detect current language
  const currentLang = navigator.language.startsWith('nl') ? 'nl' : 'en';
  console.log('üåç Detected language:', currentLang);
  
  // Apply translations to modal elements
  function applyModalTranslations() {
    if (typeof window.MusicadoApp !== 'undefined' && window.MusicadoApp.setLanguage) {
      window.MusicadoApp.setLanguage(currentLang);
    }
  }
  
  // Apply translations after a short delay to ensure MusicadoApp is loaded
  setTimeout(applyModalTranslations, 100);
  
  // Verify both steps exist
  const emailStep = document.getElementById('emailStep');
  const codeStep = document.getElementById('codeStep');
  console.log('üìä Modal steps check:', { 
    emailStep: !!emailStep, 
    codeStep: !!codeStep 
  });
  
  // Close button functionality
  const closeBtn = document.querySelector('.discount-close');
  if (closeBtn) {
    closeBtn.addEventListener('click', closeDiscountModal);
  }
  
  // Email submit button - REQUIRED EMAIL & CONSENT
  const submitEmailBtn = document.getElementById('submitDiscountEmail');
  if (submitEmailBtn) {
    submitEmailBtn.addEventListener('click', function(e) {
      e.preventDefault();
      console.log('üìß Email submit clicked');
      
      const emailInput = document.getElementById('discountEmail');
      const consentCheckbox = document.getElementById('emailConsent');
      const email = emailInput ? emailInput.value.trim() : '';
      const hasConsent = consentCheckbox ? consentCheckbox.checked : false;
      
      // Get error messages in current language
      const errorMessages = {
        en: {
          emailRequired: 'Please enter your email address to receive your discount code.',
          emailInvalid: 'Please enter a valid email address.',
          consentRequired: 'You must agree to receive emails to get your discount code.'
        },
        nl: {
          emailRequired: 'Voer uw e-mailadres in om uw kortingscode te ontvangen.',
          emailInvalid: 'Voer een geldig e-mailadres in.',
          consentRequired: 'U moet akkoord gaan met het ontvangen van e-mails om uw kortingscode te ontvangen.'
        }
      };
      
      const messages = errorMessages[currentLang] || errorMessages.en;
      
      // Reset error states
      if (emailInput) emailInput.style.borderColor = '';
      const consentSection = document.getElementById('emailConsentCheckbox');
      if (consentSection) consentSection.classList.remove('error');
      
      // REQUIRE EMAIL
      if (!email) {
        if (emailInput) {
          emailInput.style.borderColor = '#ef4444';
          emailInput.focus();
        }
        alert(messages.emailRequired);
        return;
      }
      
      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        if (emailInput) {
          emailInput.style.borderColor = '#ef4444';
          emailInput.focus();
        }
        alert(messages.emailInvalid);
        return;
      }
      
      // REQUIRE CONSENT
      if (!hasConsent) {
        if (consentSection) consentSection.classList.add('error');
        alert(messages.consentRequired);
        return;
      }
      
      // Store email and consent
      localStorage.setItem('discountEmail', email);
      localStorage.setItem('emailConsent', 'true');
      console.log('üìß Email stored:', email);
      
      // Show code step
      showCodeStep();
    });
  }
  
  // Copy code button
  const copyBtn = document.getElementById('copyDiscountCode');
  if (copyBtn) {
    copyBtn.addEventListener('click', function(e) {
      e.preventDefault();
      console.log('üìã Copy code clicked');
      copyDiscountCode();
    });
  }
  
  // Click outside to close
  const modal = document.getElementById('discountModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeDiscountModal();
      }
    });
  }
  
  // ESC key to close
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal && modal.style.display === 'block') {
      closeDiscountModal();
    }
  });
});
</script>

<style>
/* Discount Modal Styles - Same as before but enhanced for translations */
.discount-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(8px);
  z-index: 10000;
  animation: fadeIn 0.3s ease-out;
}

.discount-modal-overlay {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  padding: 20px;
}

.discount-modal .modal-content {
  background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(51, 65, 85, 0.95) 100%);
  backdrop-filter: blur(25px) saturate(180%);
  border-radius: 24px;
  padding: 2.5rem;
  max-width: 500px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  box-shadow: 
    0 25px 60px rgba(0,0,0,0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.1),
    0 0 0 1px rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(59, 130, 246, 0.3);
  color: #e2e8f0;
  animation: slideInUp 0.4s ease-out;
}

.discount-close {
  position: absolute;
  top: 1rem;
  right: 1.5rem;
  font-size: 2rem;
  color: #94a3b8;
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 1;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(59, 130, 246, 0.2);
}

.discount-close:hover {
  color: #ef4444;
  background: rgba(239, 68, 68, 0.1);
  border-color: rgba(239, 68, 68, 0.3);
  transform: scale(1.1);
}

.discount-step h2 {
  color: #06b6d4;
  margin-bottom: 1rem;
  font-size: 1.75rem;
  font-weight: 700;
  text-align: center;
  text-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
}

.discount-step p {
  color: #cbd5e1;
  margin-bottom: 2rem;
  font-size: 1.1rem;
  line-height: 1.6;
  text-align: center;
}

/* Email Form Styles */
.email-form {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.email-form input[type="email"] {
  width: 100%;
  padding: 16px 20px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  font-size: 1rem;
  background: rgba(15, 23, 42, 0.6);
  backdrop-filter: blur(10px);
  color: #e2e8f0;
  transition: all 0.3s ease;
  box-shadow: 
    inset 0 1px 3px rgba(0, 0, 0, 0.2),
    0 1px 0 rgba(255, 255, 255, 0.05);
}

.email-form input[type="email"]:focus {
  outline: none;
  border-color: rgba(59, 130, 246, 0.6);
  box-shadow: 
    0 0 0 3px rgba(59, 130, 246, 0.1),
    inset 0 1px 3px rgba(0, 0, 0, 0.2),
    0 0 20px rgba(59, 130, 246, 0.2);
  background: rgba(15, 23, 42, 0.8);
  transform: translateY(-2px);
}

.email-form input[type="email"]::placeholder {
  color: #94a3b8;
}

.email-consent-section {
  margin: 1rem 0;
}

.consent-checkbox {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  cursor: pointer;
  color: #cbd5e1;
  font-size: 0.9rem;
  line-height: 1.5;
  transition: all 0.3s ease;
}

.consent-checkbox input[type="checkbox"] {
  width: 20px;
  height: 20px;
  margin: 0;
  cursor: pointer;
  accent-color: #3b82f6;
  transform: scale(1.1);
  flex-shrink: 0;
  margin-top: 2px;
}

.email-consent-section.error {
  animation: shake 0.5s ease-in-out;
}

.email-consent-section.error .consent-checkbox {
  color: #ef4444;
}

/* Discount Code Display */
.discount-code-display {
  margin: 2rem 0;
  text-align: center;
}

.code-box {
  background: rgba(15, 23, 42, 0.8);
  border: 2px solid rgba(59, 130, 246, 0.3);
  border-radius: 16px;
  padding: 1.5rem;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  backdrop-filter: blur(10px);
  box-shadow: 
    0 8px 25px rgba(59, 130, 246, 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.discount-code-text {
  font-family: 'Courier New', monospace;
  font-size: 1.5rem;
  font-weight: 700;
  color: #fbbf24;
  text-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
  letter-spacing: 2px;
  flex: 1;
  text-align: left;
}

.copy-code-btn {
  background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  color: #1e293b;
  border: none;
  border-radius: 10px;
  padding: 12px 20px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9rem;
  white-space: nowrap;
  min-width: 120px;
  box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
}

.copy-code-btn:hover {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(251, 191, 36, 0.4);
}

.code-validity-info {
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.2);
  border-radius: 12px;
  padding: 1rem;
  margin: 1.5rem 0;
  text-align: center;
}

.code-validity-info p {
  margin: 0;
  color: #94a3b8;
  font-style: italic;
}

/* Button Styles */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 16px 24px;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  text-decoration: none;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
  position: relative;
  overflow: hidden;
  min-height: 56px;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(255, 255, 255, 0.2), 
    transparent);
  transition: left 0.4s ease;
  pointer-events: none;
}

.btn:hover::before {
  left: 100%;
}

.discount-submit-btn {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  width: 100%;
  box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
  font-size: 1.1rem;
  font-weight: 700;
}

.discount-submit-btn:hover {
  background: linear-gradient(135deg, #059669 0%, #047857 100%);
  transform: translateY(-2px);
  box-shadow: 0 15px 35px rgba(16, 185, 129, 0.4);
}

.continue-shopping-btn {
  background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
  color: white;
  width: 100%;
  box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
  font-size: 1.1rem;
  font-weight: 700;
}

.continue-shopping-btn:hover {
  background: linear-gradient(135deg, #2563eb 0%, #0284c7 100%);
  transform: translateY(-2px);
  box-shadow: 0 15px 35px rgba(59, 130, 246, 0.4);
}

.privacy-note {
  text-align: center;
  margin-top: 1.5rem;
  padding-top: 1rem;
  border-top: 1px solid rgba(59, 130, 246, 0.2);
}

.privacy-note small {
  color: #94a3b8;
  font-style: italic;
  font-size: 0.85rem;
}

/* Full Album Form Styles */
.full-album-form {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.form-group label {
  font-weight: 600;
  color: #f1f5f9;
  font-size: 0.95rem;
}

.form-group input,
.form-group textarea {
  width: 100%;
  padding: 14px 16px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  font-size: 1rem;
  background: rgba(15, 23, 42, 0.6);
  backdrop-filter: blur(10px);
  color: #e2e8f0;
  transition: all 0.3s ease;
  box-shadow: 
    inset 0 1px 3px rgba(0, 0, 0, 0.2),
    0 1px 0 rgba(255, 255, 255, 0.05);
}

.form-group input:focus,
.form-group textarea:focus {
  outline: none;
  border-color: rgba(59, 130, 246, 0.6);
  box-shadow: 
    0 0 0 3px rgba(59, 130, 246, 0.1),
    inset 0 1px 3px rgba(0, 0, 0, 0.2),
    0 0 20px rgba(59, 130, 246, 0.2);
  background: rgba(15, 23, 42, 0.8);
  transform: translateY(-1px);
}

.form-group input::placeholder,
.form-group textarea::placeholder {
  color: #94a3b8;
}

.full-album-submit-btn {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  width: 100%;
  box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
  font-size: 1.1rem;
  font-weight: 700;
  margin-top: 1rem;
}

.full-album-submit-btn:hover {
  background: linear-gradient(135deg, #059669 0%, #047857 100%);
  transform: translateY(-2px);
  box-shadow: 0 15px 35px rgba(16, 185, 129, 0.4);
}

/* Animations */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slideInUp {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
  .discount-modal-overlay {
    padding: 10px;
  }
  
  .discount-modal .modal-content {
    padding: 2rem 1.5rem;
    max-height: 95vh;
  }
  
  .discount-step h2 {
    font-size: 1.5rem;
  }
  
  .discount-step p {
    font-size: 1rem;
  }
  
  .code-box {
    flex-direction: column;
    gap: 1rem;
    text-align: center;
  }
  
  .discount-code-text {
    font-size: 1.25rem;
    text-align: center;
  }
  
  .copy-code-btn {
    width: 100%;
    min-width: unset;
  }
}

@media (max-width: 480px) {
  .discount-modal .modal-content {
    padding: 1.5rem 1rem;
    margin: 5px;
    border-radius: 16px;
  }
  
  .discount-step h2 {
    font-size: 1.25rem;
  }
  
  .discount-code-text {
    font-size: 1.1rem;
    letter-spacing: 1px;
  }
  
  .btn {
    padding: 14px 20px;
    font-size: 15px;
    min-height: 52px;
  }
}
</style>
